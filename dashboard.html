{% verbatim %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskHive - Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">

  <style>
    body {
      font-family: 'Roboto Mono', monospace;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    h1, h2, h3, h4 { font-family: 'Orbitron', sans-serif; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease-in-out; }
    .fade-enter, .fade-leave-to { opacity: 0; }
    .drag-over {
      background-color: rgba(0, 255, 255, 0.1);
      border: 2px dashed #00ffff;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
    .task-card {
      transition: all 0.3s ease;
      border-radius: 12px;
    }
    .task-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .file-progress {
      transition: width 0.3s ease;
      background: linear-gradient(to right, #00ffff, #ff00ff);
    }
    .modal { transition: all 0.3s ease; backdrop-filter: blur(5px); }
    .context-menu {
      box-shadow: 0 10px 15px -3px rgba(0, 255, 255, 0.1),
                  0 4px 6px -2px rgba(0, 0, 0, 0.05),
                  0 0 20px rgba(0, 255, 255, 0.2);
      background: rgba(17, 24, 39, 0.9);
      border: 1px solid rgba(0, 255, 255, 0.2);
    }
    .project-card {
      transition: all 0.3s ease;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.9),
                                         rgba(55, 65, 81, 0.9));
      border: 1px solid rgba(0, 255, 255, 0.1);
    }
    .project-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 0 25px rgba(0, 255, 255, 0.3),
                  0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    .confirmation-modal {
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }
    .empty-state {
      background-color: rgba(31, 41, 55, 0.7);
      border: 2px dashed rgba(0, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .glow { box-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
    .neon-text {
      text-shadow: 0 0 5px rgba(0, 255, 255, 0.5),
                   0 0 10px rgba(0, 255, 255, 0.3);
    }
    .neon-button {
      background: linear-gradient(to right, #00ffff, #ff00ff);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
      transition: all 0.3s ease;
    }
    .neon-button:hover {
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5),
                  0 0 30px rgba(255, 0, 255, 0.3);
      transform: translateY(-1px);
    }
    .search-input:focus {
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
      border-color: #00ffff;
    }
    .search-results {
      background: rgba(17, 24, 39, 0.95);
      border: 1px solid rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }
    body.light-mode { background-color: #f9fafb; color: #111827; }
    body.light-mode .bg-gray-900 { background-color:#f3f4f6 !important; color:#111827; }
    body.light-mode .bg-gray-800 { background-color:#e5e7eb !important; color:#111827; }
    body.light-mode .bg-gray-700 { background-color:#d1d5db !important; color:#111827; }
    body.light-mode .text-gray-100 { color:#111827 !important; }
    body.light-mode .text-gray-300 { color:#4b5563 !important; }
  </style>

  <script>
    // ✅ Django CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen">
<div id="app" class="flex flex-col min-h-screen" @click="closeContextMenu">

  <!-- Header -->
  <header class="bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 shadow-md py-4 px-6 flex justify-between items-center">
    <div class="flex items-center">
      <div class="text-cyan-400 text-2xl mr-3 neon-text animate-pulse">
        <i class="fas fa-bug"></i>
      </div>
      <div>
        <h1 class="text-xl font-bold text-cyan-300 neon-text">TaskHive</h1>
        <p class="text-xs text-gray-400">
          Logged in as:
          <span class="text-cyan-300">{{ currentUserName }}</span>
        </p>
      </div>
    </div>

    <!-- Search -->
    <div class="relative w-1/3 hidden md:block">
      <input
        ref="searchInput"
        v-model="searchQuery"
        @keydown.enter.prevent="goToHighlightedResult"
        @keydown.down.prevent="moveSelection(1)"
        @keydown.up.prevent="moveSelection(-1)"
        placeholder="Search tasks, projects, files (Ctrl+K)..."
        class="search-input w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg
               focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all"
      />
      <div class="absolute left-3 top-2.5 text-gray-400">
        <i class="fas fa-search"></i>
      </div>

      <!-- Search Results -->
      <div v-if="searchQuery" class="search-results absolute z-50 mt-1 w-full rounded-lg shadow-lg max-h-96 overflow-y-auto">
        <!-- Tasks -->
        <div v-if="globalResults.tasks.length" class="p-2">
          <h3 class="px-3 py-1 text-xs font-semibold text-cyan-300 uppercase tracking-wider">Tasks</h3>
          <div
            v-for="(task, index) in globalResults.tasks"
            :key="task.id"
            @click="selectSearchResult(task, 'task')"
            class="px-3 py-2 rounded-md cursor-pointer flex items-center"
            :class="{
              'bg-cyan-900/50': isHighlighted(index),
              'hover:bg-gray-700': !isHighlighted(index)
            }"
          >
            <div class="bg-cyan-900 text-cyan-300 p-2 rounded-md mr-3">
              <i class="fas fa-tasks"></i>
            </div>
            <div>
              <p class="font-medium text-gray-100">{{ task.name }}</p>
              <p class="text-sm text-gray-400">Task · {{ getBoardName(task.boardId) }}</p>
            </div>
          </div>
        </div>

        <!-- Projects -->
        <div v-if="globalResults.projects.length" class="p-2">
          <h3 class="px-3 py-1 text-xs font-semibold text-cyan-300 uppercase tracking-wider">Projects</h3>
          <div
            v-for="(project, index) in globalResults.projects"
            :key="project.id"
            @click="selectSearchResult(project, 'project')"
            class="px-3 py-2 rounded-md cursor-pointer flex items-center"
            :class="{
              'bg-cyan-900/50': isHighlighted(index + globalResults.tasks.length),
              'hover:bg-gray-700': !isHighlighted(index + globalResults.tasks.length)
            }"
          >
            <div class="bg-purple-900 text-purple-300 p-2 rounded-md mr-3">
              <i class="fas fa-project-diagram"></i>
            </div>
            <div>
              <p class="font-medium text-gray-100">{{ project.name }}</p>
              <p class="text-sm text-gray-400">Project</p>
            </div>
          </div>
        </div>

        <!-- Files -->
        <div v-if="globalResults.files.length" class="p-2">
          <h3 class="px-3 py-1 text-xs font-semibold text-cyan-300 uppercase tracking-wider">Files</h3>
          <div
            v-for="(file, index) in globalResults.files"
            :key="file.id"
            @click="selectSearchResult(file, 'file')"
            class="px-3 py-2 rounded-md cursor-pointer flex items-center"
            :class="{
              'bg-cyan-900/50': isHighlighted(index + globalResults.tasks.length + globalResults.projects.length),
              'hover:bg-gray-700': !isHighlighted(index + globalResults.tasks.length + globalResults.projects.length)
            }"
          >
            <div class="bg-pink-900 text-pink-300 p-2 rounded-md mr-3">
              <i class="fas fa-file"></i>
            </div>
            <div>
              <p class="font-medium text-gray-100">{{ file.name }}</p>
              <p class="text-sm text-gray-400">File · {{ file.type }}</p>
            </div>
          </div>
        </div>

        <div v-if="!flatResults.length" class="px-3 py-4 text-center text-gray-400">
          No results found for "{{ searchQuery }}"
        </div>
      </div>
    </div>

    <!-- Right nav -->
    <div class="flex items-center space-x-3">
      <a href="/" class="hidden sm:inline text-cyan-300 text-sm hover:text-cyan-200">
        <i class="fas fa-grid-2 mr-1"></i> Board
      </a>
      <a href="/analytics/" class="hidden sm:inline text-gray-300 text-sm hover:text-cyan-300">
        <i class="fas fa-chart-line mr-1"></i> Analytics
      </a>
      <a href="/collaboration/" class="hidden sm:inline text-gray-300 text-sm hover:text-cyan-300">
        <i class="fas fa-comments mr-1"></i> Collaboration
      </a>

      <button @click="toggleTheme"
              class="w-8 h-8 rounded-full flex items-center justify-center bg-gray-800 hover:bg-gray-700 transition-all"
              :title="isDark ? 'Light mode' : 'Dark mode'">
        <i v-if="isDark" class="fas fa-sun text-yellow-300 text-xs"></i>
        <i v-else class="fas fa-moon text-indigo-400 text-xs"></i>
      </button>

      <button @click="logout"
              class="hidden md:inline px-3 py-1 rounded-lg text-xs bg-red-700 hover:bg-red-600 text-white">
        <i class="fas fa-right-from-bracket mr-1"></i> Logout
      </button>

      <div class="w-8 h-8 bg-cyan-500 rounded-full flex items-center justify-center text-gray-900 font-semibold glow">
        {{ currentUserInitials }}
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex flex-1 overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-72 bg-gray-800 shadow-md py-6 px-4 flex flex-col">
      <nav class="space-y-1 flex-1">
        <button
          v-for="tab in tabs"
          :key="tab.id"
          @click="currentTab = tab.id"
          class="w-full flex items-center px-4 py-3 text-left rounded-lg transition-colors"
          :class="{
            'bg-cyan-900/50 text-cyan-300': currentTab === tab.id,
            'text-gray-300 hover:bg-gray-700': currentTab !== tab.id
          }"
        >
          <i :class="tab.icon" class="mr-3 w-5"></i>
          <span class="font-medium">{{ tab.name }}</span>
        </button>
      </nav>

      <!-- Teams -->
      <div class="pt-6 border-t border-gray-700">
        <h3 class="px-4 text-xs font-semibold text-cyan-300 uppercase tracking-wider mb-3">Teams</h3>
        <div class="space-y-1 max-h-52 overflow-y-auto pr-1">
          <div
            v-for="team in teams"
            :key="team.id"
            class="flex items-center justify-between px-4 py-2 rounded-lg hover:bg-gray-700 text-gray-300"
          >
            <div class="flex items-center">
              <span class="w-2 h-2 rounded-full mr-3 glow" :style="{ backgroundColor: team.color }"></span>
              <span>{{ team.name }}</span>
            </div>
            <div class="flex items-center space-x-2 text-xs">
              <button @click.stop="startEditTeam(team)" class="text-yellow-300 hover:text-yellow-200">
                <i class="fas fa-edit"></i>
              </button>
              <button @click.stop="confirmDeleteTeam(team)" class="text-red-400 hover:text-red-300">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div v-if="teams.length === 0" class="px-4 py-2 text-xs text-gray-400">
            No teams yet. Add your first team below.
          </div>
        </div>

        <!-- Add / Edit team form -->
        <div class="mt-3 bg-gray-900/70 rounded-lg p-3">
          <p class="text-[11px] text-gray-400 mb-2">
            {{ editingTeamId ? 'Edit team' : 'Add new team' }}
          </p>
          <input
            v-model="newTeamName"
            placeholder="Team name"
            class="w-full mb-2 px-2 py-1 bg-gray-800 border border-gray-700 rounded text-xs text-gray-100 focus:outline-none focus:ring-1 focus:ring-cyan-500"
          />
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center space-x-2">
              <label class="text-[11px] text-gray-400">Color:</label>
              <input type="color" v-model="newTeamColor" class="w-8 h-6 border-0 p-0 bg-transparent" />
            </div>
            <button v-if="editingTeamId" @click="resetTeamForm" class="text-[11px] text-gray-300 hover:text-gray-100">
              Cancel
            </button>
          </div>
          <button
            @click="createOrUpdateTeam"
            class="w-full py-1.5 rounded-lg text-xs text-white neon-button flex items-center justify-center"
          >
            <i class="fas" :class="editingTeamId ? 'fa-save mr-2' : 'fa-plus mr-2'"></i>
            {{ editingTeamId ? 'Update Team' : 'Add Team' }}
          </button>
        </div>
      </div>
    </aside>

    <!-- Content -->
    <div class="flex-1 overflow-auto p-6 bg-gray-900">
      <!-- Projects -->
      <div v-if="currentTab === 'projects'" class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-cyan-300 neon-text">Projects</h2>
          <button @click="openNewProject" class="neon-button text-white px-4 py-2 rounded-lg flex items-center">
            <i class="fas fa-plus mr-2"></i> New Project
          </button>
        </div>

        <div v-if="projects.length" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div
            v-for="project in projects"
            :key="project.id"
            class="project-card p-5 cursor-pointer relative group"
            @click="viewProject(project)"
          >
            <button @click.stop="confirmDeleteProject(project)"
                    class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity">
              <i class="fas fa-trash"></i>
            </button>
            <div class="flex justify-between items-start mb-4">
              <div class="w-10 h-10 rounded-lg bg-cyan-900/50 flex items-center justify-center text-cyan-400 glow">
                <i class="fas fa-project-diagram"></i>
              </div>
              <div class="text-xs px-2 py-1 rounded-full" :class="{
                  'bg-green-900/50 text-green-300': project.status === 'active',
                  'bg-gray-900/50 text-gray-300': project.status === 'completed',
                  'bg-yellow-900/50 text-yellow-300': project.status === 'on-hold'
                }">
                {{ formatStatus(project.status) }}
              </div>
            </div>
            <h3 class="font-semibold text-lg mb-2 text-gray-100">{{ project.name }}</h3>
            <p class="text-gray-400 text-sm mb-4 line-clamp-2">{{ project.description }}</p>

            <div class="flex justify-between items-center text-sm text-gray-400">
              <div class="flex items-center">
                <i class="fas fa-tasks mr-1"></i>
                <span>{{ getProjectTaskCount(project.id) }} tasks</span>
              </div>
              <div class="flex -space-x-2">
                <div
                  v-for="member in (project.members || []).slice(0, 3)"
                  :key="member"
                  class="w-6 h-6 rounded-full bg-cyan-500 text-gray-900 text-xs flex items-center justify-center border border-gray-700 glow"
                  :title="member"
                >
                  {{ getInitials(member) }}
                </div>
                <div v-if="(project.members || []).length > 3"
                     class="w-6 h-6 rounded-full bg-gray-700 text-gray-300 text-xs flex items-center justify-center border border-gray-700"
                     :title="project.members.slice(3).join(', ')">
                  +{{ project.members.length - 3 }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div v-else class="empty-state p-8 text-center">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center text-gray-400 glow">
            <i class="fas fa-project-diagram text-2xl"></i>
          </div>
          <h3 class="text-lg font-medium text-gray-100 mb-2">No projects yet</h3>
          <p class="text-gray-400 mb-4">Get started by creating your first project</p>
          <button @click="openNewProject"
                  class="neon-button text-white px-4 py-2 rounded-lg inline-flex items-center">
            <i class="fas fa-plus mr-2"></i> New Project
          </button>
        </div>
      </div>

      <!-- Tasks -->
      <div v-if="currentTab === 'tasks'" class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-cyan-300 neon-text">Tasks</h2>
          <button @click="openNewTask" class="neon-button text-white px-4 py-2 rounded-lg flex items-center">
            <i class="fas fa-plus mr-2"></i> New Task
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            v-for="board in boards"
            :key="board.id"
            class="bg-gray-800 rounded-lg p-4 min-h-[500px] bg-gradient-to-b from-gray-900 via-gray-800 to-gray-900"
            @drop.prevent="moveTask($event, board.id)"
            @dragover.prevent
            @dragenter="setDragOver(board.id, true)"
            @dragleave="setDragOver(board.id, false)"
            :class="{'drag-over': dragOverBoard === board.id}"
          >
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold text-gray-100 neon-text">{{ board.name }}</h3>
              <span class="bg-gray-700 text-gray-300 text-xs font-medium px-2 py-1 rounded-full">
                {{ tasks.filter(t => t.boardId === board.id).length }}
              </span>
            </div>

            <div class="space-y-3">
              <div
                v-for="task in tasks.filter(t => t.boardId === board.id)"
                :key="task.id"
                class="task-card bg-gray-800 shadow p-4 cursor-move border-l-4"
                :class="{
                  'border-red-500': task.priority === 'high',
                  'border-yellow-500': task.priority === 'medium',
                  'border-green-500': task.priority === 'low'
                }"
                draggable="true"
                @dragstart="startDrag($event, task)"
                @click="editTask(task)"
                @contextmenu.prevent="showTaskContextMenu($event, task)"
              >
                <div class="flex justify-between items-start mb-2">
                  <h4 class="font-medium text-gray-100">{{ task.name }}</h4>
                  <div class="text-xs px-2 py-1 rounded-full" :class="{
                    'bg-red-900/50 text-red-300': task.priority === 'high',
                    'bg-yellow-900/50 text-yellow-300': task.priority === 'medium',
                    'bg-green-900/50 text-green-300': task.priority === 'low'
                  }">
                    {{ task.priority }}
                  </div>
                </div>
                <p class="text-gray-400 text-sm mb-3">{{ task.description }}</p>

                <div class="flex justify-between items-center text-xs text-gray-400">
                  <span><i class="far fa-clock mr-1"></i> {{ formatDate(task.dueDate) }}</span>
                  <div class="flex">
                    <div
                      v-for="assignee in (task.assignees || [])"
                      :key="assignee"
                      class="w-6 h-6 rounded-full bg-cyan-500 text-gray-900 text-xs flex items-center justify-center border border-gray-700 -ml-1 glow"
                      :title="assignee"
                    >
                      {{ getInitials(assignee) }}
                    </div>
                  </div>
                </div>
              </div>

              <div v-if="tasks.filter(t => t.boardId === board.id).length===0" class="text-xs text-gray-500 text-center mt-8">
                No tasks yet.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Files -->
      <div v-if="currentTab === 'files'" class="space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold text-cyan-300 neon-text">Files</h2>
          <div>
            <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden">
            <button @click="$refs.fileInput.click()"
                    class="neon-button text-white px-4 py-2 rounded-lg flex items-center">
              <i class="fas fa-plus mr-2"></i> Upload File
            </button>
          </div>
        </div>

        <div v-if="uploadProgress > 0 && uploadProgress < 100"
             class="bg-gray-800 rounded-lg p-4 shadow glow">
          <div class="flex justify-between items-center mb-2">
            <span class="font-medium text-gray-100">Uploading file...</span>
            <span class="text-sm text-gray-400">{{ uploadProgress }}%</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div class="h-2 rounded-full file-progress"
                 :style="{ width: uploadProgress + '%' }"></div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div
            v-for="file in files"
            :key="file.id"
            class="project-card p-5 relative group"
            @contextmenu.prevent="showFileContextMenu($event, file)"
          >
            <button @click="confirmDeleteFile(file)"
                    class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity">
              <i class="fas fa-times"></i>
            </button>
            <div class="flex justify-center mb-4">
              <div class="w-12 h-12 rounded-lg flex items-center justify-center text-2xl glow"
                   :class="{
                     'bg-blue-900/50 text-blue-300': file.type === 'doc' || file.type === 'docx',
                     'bg-red-900/50 text-red-300': file.type === 'pdf',
                     'bg-green-900/50 text-green-300': file.type === 'xls' || file.type === 'xlsx',
                     'bg-yellow-900/50 text-yellow-300': file.type === 'zip',
                     'bg-purple-900/50 text-purple-300': file.type === 'png' || file.type === 'jpg' || file.type === 'jpeg'
                   }">
                <i class="fas" :class="{
                  'fa-file-word': file.type === 'doc' || file.type === 'docx',
                  'fa-file-pdf': file.type === 'pdf',
                  'fa-file-excel': file.type === 'xls' || file.type === 'xlsx',
                  'fa-file-archive': file.type === 'zip',
                  'fa-file-image': file.type === 'png' || file.type === 'jpg' || file.type === 'jpeg',
                  'fa-file-alt': file.type === 'txt' || file.type === 'other'
                }"></i>
              </div>
            </div>
            <h3 class="font-semibold text-center mb-1 truncate text-gray-100">{{ file.name }}</h3>
            <p class="text-gray-400 text-sm text-center mb-3">{{ file.size }}</p>

            <div class="flex justify-between items-center text-xs text-gray-400">
              <span>{{ formatDate(file.uploaded) }}</span>
              <div class="flex space-x-2">
                <button @click="downloadFile(file)" class="text-blue-400 hover:text-blue-200">
                  <i class="fas fa-download"></i>
                </button>
                <button @click="openFile(file)" class="text-green-400 hover:text-green-200">
                  <i class="fas fa-external-link-alt"></i>
                </button>
              </div>
            </div>
          </div>

          <div v-if="files.length===0" class="text-gray-500 text-sm">
            No files yet.
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Task Modal -->
  <transition name="fade">
    <div v-if="showTaskModal" class="fixed inset-0 z-40 flex items-center justify-center confirmation-modal">
      <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-lg p-6 border border-cyan-500/40 modal">
        <h3 class="text-lg font-semibold text-cyan-300 mb-4">
          {{ editingTask ? 'Edit Task' : 'New Task' }}
        </h3>
        <div class="space-y-3 text-sm">
          <div>
            <label class="block text-gray-300 mb-1">Task Name</label>
            <input v-model="currentTask.name"
                   class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500">
          </div>
          <div>
            <label class="block text-gray-300 mb-1">Description</label>
            <textarea v-model="currentTask.description" rows="3"
                      class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500"></textarea>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-gray-300 mb-1">Priority</label>
              <select v-model="currentTask.priority"
                      class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-300 mb-1">Due Date</label>
              <input type="date" v-model="currentTask.dueDate"
                     class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500">
            </div>
          </div>
        </div>

        <div class="mt-5 flex justify-end space-x-3">
          <button @click="closeTaskModal"
                  class="px-4 py-2 rounded-lg text-sm bg-gray-700 text-gray-200 hover:bg-gray-600">
            Cancel
          </button>
          <button @click="saveTask"
                  class="px-4 py-2 rounded-lg text-sm text-white neon-button">
            {{ editingTask ? 'Save Changes' : 'Create Task' }}
          </button>
        </div>
      </div>
    </div>
  </transition>

  <!-- Project Modal -->
  <transition name="fade">
    <div v-if="showProjectModal" class="fixed inset-0 z-40 flex items-center justify-center confirmation-modal">
      <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-lg p-6 border border-cyan-500/40 modal">
        <h3 class="text-lg font-semibold text-cyan-300 mb-4">
          {{ editingProject ? 'Edit Project' : 'New Project' }}
        </h3>
        <div class="space-y-3 text-sm">
          <div>
            <label class="block text-gray-300 mb-1">Project Name</label>
            <input v-model="currentProject.name"
                   class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500">
          </div>
          <div>
            <label class="block text-gray-300 mb-1">Description</label>
            <textarea v-model="currentProject.description" rows="3"
                      class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500"></textarea>
          </div>
          <div>
            <label class="block text-gray-300 mb-1">Status</label>
            <select v-model="currentProject.status"
                    class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded text-gray-100 focus:outline-none focus:ring-2 focus:ring-cyan-500">
              <option value="active">Active</option>
              <option value="completed">Completed</option>
              <option value="on-hold">On-hold</option>
            </select>
          </div>
        </div>

        <div class="mt-5 flex justify-end space-x-3">
          <button @click="closeProjectModal"
                  class="px-4 py-2 rounded-lg text-sm bg-gray-700 text-gray-200 hover:bg-gray-600">
            Cancel
          </button>
          <button @click="saveProject"
                  class="px-4 py-2 rounded-lg text-sm text-white neon-button">
            {{ editingProject ? 'Save Changes' : 'Create Project' }}
          </button>
        </div>
      </div>
    </div>
  </transition>

  <!-- Confirmation Modal -->
  <transition name="fade">
    <div v-if="showConfirmationModal" class="fixed inset-0 z-50 flex items-center justify-center confirmation-modal">
      <div class="bg-gray-900 rounded-xl shadow-xl w-full max-w-sm p-6 border border-red-500/40">
        <h3 class="text-lg font-semibold text-red-400 mb-2">Are you sure?</h3>
        <p class="text-sm text-gray-300 mb-4">
          This will permanently delete the {{ itemToDelete.type }}:
          <span class="font-semibold">{{ itemToDelete.name }}</span>
        </p>
        <div class="flex justify-end space-x-3">
          <button @click="showConfirmationModal = false"
                  class="px-4 py-2 rounded-lg text-sm bg-gray-700 text-gray-200 hover:bg-gray-600">
            Cancel
          </button>
          <button @click="executeDelete"
                  class="px-4 py-2 rounded-lg text-sm bg-red-600 text-white hover:bg-red-500">
            Delete
          </button>
        </div>
      </div>
    </div>
  </transition>

  <!-- Context Menu -->
  <div v-if="contextMenu.visible" class="fixed z-50 context-menu rounded-lg py-1"
       :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }">
    <div v-if="contextMenu.type === 'task'" class="min-w-[150px]">
      <button @click="editTask(contextMenu.item)"
              class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center transition-colors text-gray-100">
        <i class="fas fa-edit mr-2 text-cyan-400"></i> Edit
      </button>
      <button @click="confirmDeleteTask(contextMenu.item)"
              class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center transition-colors text-gray-100">
        <i class="fas fa-trash mr-2 text-red-400"></i> Delete
      </button>
    </div>
    <div v-if="contextMenu.type === 'file'" class="min-w-[150px]">
      <button @click="openFile(contextMenu.item)"
              class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center transition-colors text-gray-100">
        <i class="fas fa-external-link-alt mr-2 text-green-400"></i> Open
      </button>
      <button @click="downloadFile(contextMenu.item)"
              class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center transition-colors text-gray-100">
        <i class="fas fa-download mr-2 text-cyan-400"></i> Download
      </button>
      <button @click="confirmDeleteFile(contextMenu.item)"
              class="w-full text-left px-4 py-2 hover:bg-gray-700 flex items-center transition-colors text-gray-100">
        <i class="fas fa-trash mr-2 text-red-400"></i> Delete
      </button>
    </div>
  </div>

  <!-- Toast -->
  <transition name="fade">
    <div v-if="showToast"
         class="fixed bottom-4 right-4 bg-gray-800 text-cyan-300 px-4 py-3 rounded-lg shadow-lg flex items-center glow">
      <i class="fas fa-check-circle mr-2"></i>
      <span>{{ toastMessage }}</span>
    </div>
  </transition>
</div>

<script>
  new Vue({
    el: '#app',
    data() {
      return {
        // UI only
        isDark: true,
        searchQuery: "",
        highlightedIndex: 0,
        currentTab: "tasks",
        dragOverBoard: null,
        showTaskModal: false,
        showProjectModal: false,
        showToast: false,
        showConfirmationModal: false,
        toastMessage: "",
        draggedTask: null,
        uploadProgress: 0,
        editingTask: false,
        editingProject: false,
        itemToDelete: { type: "", name: "", id: null },
        contextMenu: { visible: false, type: null, item: null, x: 0, y: 0 },

        // DB data
        me: { name: "User", email: "" },
        teams: [],
        newTeamName: "",
        newTeamColor: "#00ffff",
        editingTeamId: null,

        currentTask: {
          id: null, name: "", description: "",
          priority: "medium", dueDate: "", assignees: [], boardId: 1
        },
        currentProject: {
          id: null, name: "", description: "",
          status: "active", members: []
        },

        tabs: [
          { id: 'projects', name: 'Projects', icon: 'fas fa-project-diagram' },
          { id: 'tasks',    name: 'Tasks',    icon: 'fas fa-tasks' },
          { id: 'files',    name: 'Files',    icon: 'fas fa-file-alt' }
        ],
        boards: [
          { id: 1, name: "Todo" },
          { id: 2, name: "In Progress" },
          { id: 3, name: "Done" }
        ],

        tasks: [],
        projects: [],
        files: []
      };
    },

    computed: {
      globalResults() {
        const q = this.searchQuery.toLowerCase();
        return {
          tasks: this.tasks.filter((t) =>
            (t.name || "").toLowerCase().includes(q) || (t.description || "").toLowerCase().includes(q)
          ),
          projects: this.projects.filter((p) =>
            (p.name || "").toLowerCase().includes(q) || (p.description || "").toLowerCase().includes(q)
          ),
          files: this.files.filter((f) => (f.name || "").toLowerCase().includes(q)),
        };
      },
      flatResults() {
        return [
          ...this.globalResults.tasks.map((r) => ({ ...r, type: "task" })),
          ...this.globalResults.projects.map((r) => ({ ...r, type: "project" })),
          ...this.globalResults.files.map((r) => ({ ...r, type: "file" })),
        ];
      },

      currentUserName() {
        return (this.me && this.me.name) ? this.me.name : "User";
      },
      currentUserInitials() {
        return (this.currentUserName || "U").charAt(0).toUpperCase();
      }
    },

    async mounted() {
      this.initTheme();

      window.addEventListener("keydown", this.handleShortcut);

      // ✅ Auth via Django session (NO localStorage user)
      await this.checkAuth();

      // ✅ Load all DB data
      await this.loadData();
    },

    beforeDestroy() {
      window.removeEventListener("keydown", this.handleShortcut);
    },

    methods: {
      // ---------------- API helpers ----------------
      csrf() {
        return getCookie("csrftoken");
      },

      async apiFetch(url, options = {}) {
        const method = (options.method || "GET").toUpperCase();
        const headers = options.headers || {};

        // Send cookies (session)
        options.credentials = "same-origin";

        // JSON default
        if (options.json) {
          headers["Content-Type"] = "application/json";
          options.body = JSON.stringify(options.json);
          delete options.json;
        }

        // CSRF for unsafe methods
        if (["POST", "PUT", "PATCH", "DELETE"].includes(method)) {
          headers["X-CSRFToken"] = this.csrf();
        }

        options.headers = headers;
        return fetch(url, options);
      },

      async checkAuth() {
        // REQUIRED ENDPOINT:
        // GET /api/me/  -> 200 {name,email}  OR 401 if not logged
        const res = await this.apiFetch("/api/me/");
        if (!res.ok) {
          const next = encodeURIComponent(window.location.pathname);
          window.location.href = `/login/?next=${next}`;
          return;
        }
        this.me = await res.json().catch(() => ({ name: "User" }));
      },

      async loadData() {
        // REQUIRED ENDPOINTS:
        // GET /api/tasks/     -> [{id,name,description,boardId,priority,dueDate,assignees}]
        // GET /api/projects/  -> [{id,name,description,status,members}]
        // GET /api/files/     -> [{id,name,type,size,uploaded,url}]
        // GET /api/teams/     -> [{id,name,color}]

        const [t, p, f, te] = await Promise.all([
          this.apiFetch("/api/tasks/"),
          this.apiFetch("/api/projects/"),
          this.apiFetch("/api/files/"),
          this.apiFetch("/api/teams/"),
        ]);

        this.tasks = t.ok ? await t.json().catch(() => []) : [];
        this.projects = p.ok ? await p.json().catch(() => []) : [];
        this.files = f.ok ? await f.json().catch(() => []) : [];
        this.teams = te.ok ? await te.json().catch(() => []) : [];
      },

      // ---------------- THEME ----------------
      initTheme() {
        const saved = localStorage.getItem("taskhive_theme");
        if (saved === "light") {
          this.isDark = false;
          document.body.classList.add("light-mode");
        } else {
          this.isDark = true;
          document.body.classList.remove("light-mode");
        }
      },
      toggleTheme() {
        this.isDark = !this.isDark;
        if (this.isDark) {
          localStorage.setItem("taskhive_theme", "dark");
          document.body.classList.remove("light-mode");
        } else {
          localStorage.setItem("taskhive_theme", "light");
          document.body.classList.add("light-mode");
        }
      },

      // ---------------- LOGOUT ----------------
      async logout() {
        // OPTIONAL ENDPOINT:
        // POST /api/logout/ -> {ok:true}
        await this.apiFetch("/api/logout/", { method: "POST" }).catch(() => {});
        window.location.href = "/login/";
      },

      // ---------------- SEARCH ----------------
      handleShortcut(e) {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
          e.preventDefault();
          this.$refs.searchInput && this.$refs.searchInput.focus();
          this.searchQuery = "";
        }
        if (e.key === "Escape" && this.searchQuery) this.searchQuery = "";
      },
      moveSelection(direction) {
        if (!this.flatResults.length) return;
        this.highlightedIndex =
          (this.highlightedIndex + direction + this.flatResults.length) %
          this.flatResults.length;
      },
      goToHighlightedResult() {
        const selected = this.flatResults[this.highlightedIndex];
        if (!selected) return;
        this.selectSearchResult(selected, selected.type);
      },
      selectSearchResult(item, type) {
        this.currentTab = type + 's';
        this.searchQuery = "";
        this.showToastMessage(`Navigated to ${type}: ${item.name}`);
      },
      isHighlighted(index) {
        return this.highlightedIndex === index;
      },
      getBoardName(boardId) {
        const board = this.boards.find(b => b.id === boardId);
        return board ? board.name : 'Unknown';
      },

      // ---------------- TASKS (DB) ----------------
      startDrag(event, task) {
        event.dataTransfer.setData("taskID", String(task.id));
        this.draggedTask = task;
      },

      async moveTask(event, boardId) {
        const taskId = parseInt(event.dataTransfer.getData("taskID"));
        const task = this.tasks.find((t) => t.id === taskId);
        if (!task) return;

        const old = task.boardId;
        task.boardId = boardId; // optimistic UI

        // REQUIRED:
        // PATCH /api/tasks/<id>/  {boardId: 2}
        const res = await this.apiFetch(`/api/tasks/${taskId}/`, {
          method: "PATCH",
          json: { boardId }
        });

        if (!res.ok) {
          task.boardId = old; // revert
          this.showToastMessage("Failed to move task");
          return;
        }

        this.showToastMessage(`Task moved to ${this.getBoardName(boardId)}`);
        this.draggedTask = null;
        this.dragOverBoard = null;
      },

      setDragOver(boardId, isOver) {
        this.dragOverBoard = isOver ? boardId : null;
      },

      openNewTask() {
        this.editingTask = false;
        this.resetCurrentTask();
        this.showTaskModal = true;
      },

      editTask(task) {
        this.currentTask = { ...task };
        this.editingTask = true;
        this.showTaskModal = true;
      },

      async saveTask() {
        if (!this.currentTask.name.trim()) {
          this.showToastMessage("Task name is required");
          return;
        }

        const payload = {
          name: this.currentTask.name,
          description: this.currentTask.description,
          priority: this.currentTask.priority,
          dueDate: this.currentTask.dueDate,
          assignees: this.currentTask.assignees || [],
          boardId: this.currentTask.boardId
        };

        if (this.editingTask && this.currentTask.id) {
          // REQUIRED:
          // PATCH /api/tasks/<id>/  payload
          const res = await this.apiFetch(`/api/tasks/${this.currentTask.id}/`, {
            method: "PATCH",
            json: payload
          });
          if (!res.ok) return this.showToastMessage("Failed to update task");
          this.showToastMessage("Task updated successfully");
        } else {
          // REQUIRED:
          // POST /api/tasks/ payload
          const res = await this.apiFetch(`/api/tasks/`, {
            method: "POST",
            json: payload
          });
          if (!res.ok) return this.showToastMessage("Failed to create task");
          this.showToastMessage("Task added successfully");
        }

        this.closeTaskModal();
        await this.loadData();
      },

      confirmDeleteTask(task) {
        this.itemToDelete = { type: 'task', name: task.name, id: task.id };
        this.showConfirmationModal = true;
        this.closeContextMenu();
      },

      async deleteTask(taskId) {
        // REQUIRED:
        // DELETE /api/tasks/<id>/
        const res = await this.apiFetch(`/api/tasks/${taskId}/`, { method: "DELETE" });
        if (!res.ok) return this.showToastMessage("Failed to delete task");
        this.showToastMessage("Task deleted successfully");
        await this.loadData();
      },

      closeTaskModal() {
        this.showTaskModal = false;
        this.editingTask = false;
        this.resetCurrentTask();
      },

      resetCurrentTask() {
        this.currentTask = {
          id: null,
          name: "",
          description: "",
          priority: "medium",
          dueDate: "",
          assignees: [],
          boardId: 1
        };
      },

      // ---------------- PROJECTS (DB) ----------------
      openNewProject() {
        this.editingProject = false;
        this.resetCurrentProject();
        this.showProjectModal = true;
      },

      viewProject(project) {
        this.currentProject = { ...project };
        this.editingProject = true;
        this.showProjectModal = true;
      },

      async saveProject() {
        if (!this.currentProject.name.trim()) {
          this.showToastMessage("Project name is required");
          return;
        }

        const payload = {
          name: this.currentProject.name,
          description: this.currentProject.description,
          status: this.currentProject.status,
          members: this.currentProject.members || []
        };

        if (this.editingProject && this.currentProject.id) {
          // REQUIRED:
          // PATCH /api/projects/<id>/
          const res = await this.apiFetch(`/api/projects/${this.currentProject.id}/`, {
            method: "PATCH",
            json: payload
          });
          if (!res.ok) return this.showToastMessage("Failed to update project");
          this.showToastMessage("Project updated successfully");
        } else {
          // REQUIRED:
          // POST /api/projects/
          const res = await this.apiFetch(`/api/projects/`, {
            method: "POST",
            json: payload
          });
          if (!res.ok) return this.showToastMessage("Failed to create project");
          this.showToastMessage("Project added successfully");
        }

        this.closeProjectModal();
        await this.loadData();
      },

      confirmDeleteProject(project) {
        this.itemToDelete = { type: 'project', name: project.name, id: project.id };
        this.showConfirmationModal = true;
        this.closeContextMenu();
        this.closeProjectModal();
      },

      async deleteProject(projectId) {
        // REQUIRED:
        // DELETE /api/projects/<id>/
        const res = await this.apiFetch(`/api/projects/${projectId}/`, { method: "DELETE" });
        if (!res.ok) return this.showToastMessage("Failed to delete project");
        this.showToastMessage("Project deleted successfully");
        await this.loadData();
      },

      closeProjectModal() {
        this.showProjectModal = false;
        this.editingProject = false;
        this.resetCurrentProject();
      },

      resetCurrentProject() {
        this.currentProject = {
          id: null,
          name: "",
          description: "",
          status: "active",
          members: []
        };
      },

      getProjectTaskCount(projectId) {
        // If your DB tasks have projectId, this becomes accurate automatically.
        // Otherwise, it will show 0.
        return this.tasks.filter(t => t.projectId === projectId).length;
      },

      // ---------------- TEAMS (DB) ----------------
      async createOrUpdateTeam() {
        const name = this.newTeamName.trim();
        if (!name) {
          this.showToastMessage("Team name is required");
          return;
        }

        const payload = { name, color: this.newTeamColor };

        if (this.editingTeamId) {
          // REQUIRED:
          // PATCH /api/teams/<id>/
          const res = await this.apiFetch(`/api/teams/${this.editingTeamId}/`, {
            method: "PATCH",
            json: payload
          });
          if (!res.ok) return this.showToastMessage("Failed to update team");
          this.showToastMessage("Team updated");
        } else {
          // REQUIRED:
          // POST /api/teams/
          const res = await this.apiFetch(`/api/teams/`, {
            method: "POST",
            json: payload
          });
          if (!res.ok) return this.showToastMessage("Failed to create team");
          this.showToastMessage("Team added");
        }

        this.resetTeamForm();
        await this.loadData();
      },

      startEditTeam(team) {
        this.editingTeamId = team.id;
        this.newTeamName = team.name;
        this.newTeamColor = team.color || "#00ffff";
      },

      confirmDeleteTeam(team) {
        this.itemToDelete = { type: 'team', name: team.name, id: team.id };
        this.showConfirmationModal = true;
      },

      async deleteTeam(teamId) {
        // REQUIRED:
        // DELETE /api/teams/<id>/
        const res = await this.apiFetch(`/api/teams/${teamId}/`, { method: "DELETE" });
        if (!res.ok) return this.showToastMessage("Failed to delete team");
        this.showToastMessage("Team deleted successfully");
        await this.loadData();
      },

      resetTeamForm() {
        this.editingTeamId = null;
        this.newTeamName = "";
        this.newTeamColor = "#00ffff";
      },

      // ---------------- FILES (DB) ----------------
      handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        this.uploadFileToServer(file);
      },

      uploadFileToServer(file) {
        // REQUIRED:
        // POST /api/files/ (multipart form-data) -> return created file object
        const form = new FormData();
        form.append("file", file);

        this.uploadProgress = 0;

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/api/files/", true);
        xhr.withCredentials = true;
        xhr.setRequestHeader("X-CSRFToken", this.csrf());

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            this.uploadProgress = Math.round((e.loaded / e.total) * 100);
          }
        };

        xhr.onload = async () => {
          this.uploadProgress = 0;
          if (xhr.status >= 200 && xhr.status < 300) {
            this.showToastMessage("File uploaded successfully");
            await this.loadData();
          } else {
            this.showToastMessage("File upload failed");
          }
        };

        xhr.onerror = () => {
          this.uploadProgress = 0;
          this.showToastMessage("File upload failed");
        };

        xhr.send(form);
      },

      downloadFile(file) {
        // file.url should be returned from API
        if (!file.url) return this.showToastMessage("No file URL found");
        const link = document.createElement('a');
        link.href = file.url;
        link.download = file.name || "download";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        this.showToastMessage(`Downloading ${file.name}`);
        this.closeContextMenu();
      },

      openFile(file) {
        if (!file.url) return this.showToastMessage("No file URL found");
        window.open(file.url, '_blank');
        this.showToastMessage(`Opening ${file.name}`);
        this.closeContextMenu();
      },

      confirmDeleteFile(file) {
        this.itemToDelete = { type: 'file', name: file.name, id: file.id };
        this.showConfirmationModal = true;
        this.closeContextMenu();
      },

      async deleteFile(fileId) {
        // REQUIRED:
        // DELETE /api/files/<id>/
        const res = await this.apiFetch(`/api/files/${fileId}/`, { method: "DELETE" });
        if (!res.ok) return this.showToastMessage("Failed to delete file");
        this.showToastMessage("File deleted successfully");
        await this.loadData();
      },

      // ---------------- MENUS + CONFIRM ----------------
      showTaskContextMenu(event, task) {
        this.contextMenu = { visible: true, type: 'task', item: task, x: event.pageX, y: event.pageY };
      },

      showFileContextMenu(event, file) {
        this.contextMenu = { visible: true, type: 'file', item: file, x: event.pageX, y: event.pageY };
      },

      closeContextMenu() {
        this.contextMenu.visible = false;
      },

      executeDelete() {
        const { type, id } = this.itemToDelete;
        if (type === 'task') this.deleteTask(id);
        else if (type === 'project') this.deleteProject(id);
        else if (type === 'file') this.deleteFile(id);
        else if (type === 'team') this.deleteTeam(id);
        this.showConfirmationModal = false;
      },

      // ---------------- UTIL ----------------
      formatDate(dateString) {
        if (!dateString) return 'No date';
        const options = { month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
      },
      formatStatus(status) {
        if (!status) return "Active";
        return status.charAt(0).toUpperCase() + status.slice(1);
      },
      getInitials(name) {
        return (name || "").substring(0, 1);
      },
      showToastMessage(message) {
        this.toastMessage = message;
        this.showToast = true;
        setTimeout(() => { this.showToast = false; }, 2500);
      }
    }
  });
</script>

</body>
</html>
{% endverbatim %}
